---
- name: Deploy Kagent Add-on to Kubernetes Cluster
  hosts: k8s_cluster
  become: yes
  gather_facts: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3
    kagent_namespace: "kagent"
    kagent_version: "latest"

  pre_tasks:
    - name: Verify Kubernetes cluster is running
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: cluster_nodes
      when: node_role == 'master'

    - name: Check if Kubernetes cluster is ready
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Node
      register: k8s_status
      when: node_role == 'master'

    - name: Verify Ollama is running
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "ollama"
      register: ollama_status
      when: node_role == 'master'

    - name: Display Kubernetes cluster status
      debug:
        msg:
          - "Kubernetes Cluster Status:"
          - "  - Cluster: {{ 'Ready' if k8s_status.resources else 'Not Found' }}"
          - "  - Ollama: {{ 'Running' if ollama_status.resources else 'Not Found (optional - can use GPT API)' }}"
          - "  - Nodes: {{ cluster_nodes.resources | length }}"
      when: node_role == 'master'

  roles:
    - role: kagent-deployment
      tags: [kagent, deployment]
      when: node_role == 'master'

    - role: mcp-tools
      tags: [mcp, tools]
      when: node_role == 'master'

    - role: gitops-setup
      tags: [gitops, argo]
      when: node_role == 'master'

  post_tasks:
    - name: Wait for kagent to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: kagent
        namespace: "{{ kagent_namespace }}"
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 600
      when: node_role == 'master'

    - name: Display kagent access information
      debug:
        msg:
          - "ğŸ‰ Kagent add-on deployed successfully!"
          - "ğŸŒ Kagent Dashboard: http://kagent.{{ cluster_ip }}.nip.io"
          - "ğŸ”— Port-forward: kubectl port-forward -n {{ kagent_namespace }} svc/kagent 8080:80"
          - "ğŸ’» Local access: http://localhost:8080"
          - "ğŸ¤– LLM: Using Ollama (local) or GPT API (OpenAI)"
          - "ğŸ“Š Observability: Available via Prometheus"
      when: node_role == 'master'

    - name: Show integration status
      debug:
        msg:
          - "ğŸ”— Integration Status:"
          - "  - Kubernetes Cluster: âœ… Connected"
          - "  - LLM Provider: âœ… Configured (Ollama or GPT API)"
          - "  - MCP Tools: âœ… Configured"
          - "  - GitOps: âœ… Ready"
      when: node_role == 'master'
